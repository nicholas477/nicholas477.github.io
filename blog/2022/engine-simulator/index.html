<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>AngeTheGreat's Engine Simulator in Unreal Engine | </title> <meta name="author" content="Nicholas Chalkley"> <meta name="description" content="the world's greatest engine simulator meets a mediocre physics engine!"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website, unreal-engine"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://nicholas477.github.io//blog/2022/engine-simulator/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"></a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item"> <a class="nav-link" href="https://epicgameguy.itch.io" rel="external nofollow noopener" target="_blank">games </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="nav-item"> <a class="nav-link" href="https://www.unrealengine.com/marketplace/en-US/profile/Big+Cat+Energising" rel="external nofollow noopener" target="_blank">marketplace </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">AngeTheGreat's Engine Simulator in Unreal Engine</h1> <p class="post-meta">October 15, 2022</p> <p class="post-tags"> <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a> </p> </header> <article class="post-content"> <h5 id="--download-links-are-at-the-bottom-of-the-article--">- Download links are at the bottom of the article -</h5> <h1 id="overview">Overview</h1> <p>I don’t remember how, but a few months ago my related videos feed got flooded with engine simulator videos. If you aren’t familiar with engine simulator, it’s a program that lets you describe engines using markup files and somehow it turns those text configs into a colorful 2d simulation and produces beautiful engine sounds. The creator’s video describes it better than I can.</p> <iframe width="100%" height="480" src="https://www.youtube.com/embed/RKT-sKtR970" title="Simulating an Entire Car Engine (yes, it makes noise)" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe> <p>You can do a youtube search for “engine simulator” and see all the <a href="https://youtu.be/PZ9ynEH9YjM" rel="external nofollow noopener" target="_blank">whacky</a> <a href="https://youtu.be/dMorJRNkWhU?list=PLViptfOL1RMftTKEBjvW-1tejbtFq21Cw" rel="external nofollow noopener" target="_blank">shit</a> other people have done with it. While these videos are cool and the simulator is incredible, it really feels like it’s begging to be put into a game engine. So that’s what I did.</p> <iframe width="100%" height="480" src="https://www.youtube.com/embed/_D4XjEji0_E" title="Engine Simulator in Unreal Engine" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture;" allowfullscreen=""></iframe> <p>I created a plugin that integrates engine simulator into Unreal Engine 5’s Chaos vehicle simulation, the plugin does this by providing a movement component that runs Engine Simulator. To use Engine Simulator to drive your Unreal Engine vehicle, you just replace your <code class="language-plaintext highlighter-rouge">ChaosWheeledVehicleMovementComponent</code> with the <code class="language-plaintext highlighter-rouge">EngineSimulatorWheeledVehicleMovementComponent</code>, and you can do this in blueprint using the subclass dropdown on your Chaos vehicle component. If you’re interested in the implementation details, I go over them in the next section.</p> <h2 id="drawbacksissues">Drawbacks/issues</h2> <p>So the plugin is honestly pretty rudimentary, and there’s some issues I can’t fix with Unreal unless I edit the engine code, which I don’t want to. But first, plugin issues:</p> <ul> <li>The clutch simulation built in to Engine Simulator is extremely basic. <ul> <li>It doesn’t model slip, it just limits torque output. I could write some code to implement a proper clutch but I don’t understand the physics side of Engine Simulator well enough to do that.</li> </ul> </li> <li>The engine visualization doesn’t show up yet. <ul> <li>This is an issue with my code, and i’m still figuring out how to implement this. In the future, I want the plugin to let people open the Engine Simulator GUI or a replica of it.</li> </ul> </li> <li>Chaos vehicles don’t handle wheel spin/wheels not in contact with the ground <ul> <li>The way the engine code is set up makes it impossible to apply torque to the wheels while in air or not in contact with the ground. I can’t fix this without making engine modifications. The plugin currently disengages the clutch when the wheels aren’t in contact or when they are spinning, and it lets the engine rev.</li> </ul> </li> </ul> <hr> <h1 id="implementation-details">Implementation Details</h1> <p>This plugin took about a week or two from start to finish, and most of the time I spent coding the plugin was just doing annoying shit like rewriting build scripts to get Engine Simulator to compile as a static lib, and massaging the code to get Engine Simulator to work with Unreal. I’m going to skip over that stuff. There’s other tutorials covering how to integrate third party libraries into Unreal, and heaps of engine code to look at too.</p> <p>What I am going to cover is how the Chaos vehicle sim integrates with Engine Sim and vice versa.</p> <h2 id="chaos-side">Chaos side</h2> <p>Bolting on a different engine to the Chaos simulation side is surprisingly easy. The engine simulation part of Chaos vehicles is almost entirely contained in the function <code class="language-plaintext highlighter-rouge">UChaosWheeledVehicleSimulation::ProcessMechanicalSimulation(float DeltaTime)</code>:</p> <figure class="highlight"><pre><code class="language-c--" data-lang="c++"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td> <td class="code"><pre><span class="kt">void</span> <span class="n">UChaosWheeledVehicleSimulation</span><span class="o">::</span><span class="n">ProcessMechanicalSimulation</span><span class="p">(</span><span class="kt">float</span> <span class="n">DeltaTime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PVehicle</span><span class="o">-&gt;</span><span class="n">HasEngine</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">auto</span><span class="o">&amp;</span> <span class="n">PEngine</span> <span class="o">=</span> <span class="n">PVehicle</span><span class="o">-&gt;</span><span class="n">GetEngine</span><span class="p">();</span>
		<span class="k">auto</span><span class="o">&amp;</span> <span class="n">PTransmission</span> <span class="o">=</span> <span class="n">PVehicle</span><span class="o">-&gt;</span><span class="n">GetTransmission</span><span class="p">();</span>
		<span class="k">auto</span><span class="o">&amp;</span> <span class="n">PDifferential</span> <span class="o">=</span> <span class="n">PVehicle</span><span class="o">-&gt;</span><span class="n">GetDifferential</span><span class="p">();</span>

		<span class="kt">float</span> <span class="n">WheelRPM</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">I</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">I</span> <span class="o">&lt;</span> <span class="n">PVehicle</span><span class="o">-&gt;</span><span class="n">Wheels</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span> <span class="n">I</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">PVehicle</span><span class="o">-&gt;</span><span class="n">Wheels</span><span class="p">[</span><span class="n">I</span><span class="p">].</span><span class="n">EngineEnabled</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">WheelRPM</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Abs</span><span class="p">(</span><span class="n">PVehicle</span><span class="o">-&gt;</span><span class="n">Wheels</span><span class="p">[</span><span class="n">I</span><span class="p">].</span><span class="n">GetWheelRPM</span><span class="p">());</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="kt">float</span> <span class="n">WheelSpeedRPM</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Abs</span><span class="p">(</span><span class="n">PTransmission</span><span class="p">.</span><span class="n">GetEngineRPMFromWheelRPM</span><span class="p">(</span><span class="n">WheelRPM</span><span class="p">));</span>
		<span class="n">PEngine</span><span class="p">.</span><span class="n">SetEngineRPM</span><span class="p">(</span><span class="n">PTransmission</span><span class="p">.</span><span class="n">IsOutOfGear</span><span class="p">(),</span> <span class="n">PTransmission</span><span class="p">.</span><span class="n">GetEngineRPMFromWheelRPM</span><span class="p">(</span><span class="n">WheelRPM</span><span class="p">));</span>
		<span class="n">PEngine</span><span class="p">.</span><span class="n">Simulate</span><span class="p">(</span><span class="n">DeltaTime</span><span class="p">);</span>

		<span class="n">PTransmission</span><span class="p">.</span><span class="n">SetEngineRPM</span><span class="p">(</span><span class="n">PEngine</span><span class="p">.</span><span class="n">GetEngineRPM</span><span class="p">());</span> <span class="c1">// needs engine RPM to decide when to change gear (automatic gearbox)</span>
		<span class="n">PTransmission</span><span class="p">.</span><span class="n">SetAllowedToChangeGear</span><span class="p">(</span><span class="o">!</span><span class="n">VehicleState</span><span class="p">.</span><span class="n">bVehicleInAir</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IsWheelSpinning</span><span class="p">());</span>
		<span class="kt">float</span> <span class="n">GearRatio</span> <span class="o">=</span> <span class="n">PTransmission</span><span class="p">.</span><span class="n">GetGearRatio</span><span class="p">(</span><span class="n">PTransmission</span><span class="p">.</span><span class="n">GetCurrentGear</span><span class="p">());</span>

		<span class="n">PTransmission</span><span class="p">.</span><span class="n">Simulate</span><span class="p">(</span><span class="n">DeltaTime</span><span class="p">);</span>

		<span class="kt">float</span> <span class="n">TransmissionTorque</span> <span class="o">=</span> <span class="n">PTransmission</span><span class="p">.</span><span class="n">GetTransmissionTorque</span><span class="p">(</span><span class="n">PEngine</span><span class="p">.</span><span class="n">GetEngineTorque</span><span class="p">());</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WheelSpeedRPM</span> <span class="o">&gt;</span> <span class="n">PEngine</span><span class="p">.</span><span class="n">Setup</span><span class="p">().</span><span class="n">MaxRPM</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">TransmissionTorque</span> <span class="o">=</span> <span class="mf">0.</span><span class="n">f</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="c1">// apply drive torque to wheels</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">WheelIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">WheelIdx</span> <span class="o">&lt;</span> <span class="n">Wheels</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span> <span class="n">WheelIdx</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">auto</span><span class="o">&amp;</span> <span class="n">PWheel</span> <span class="o">=</span> <span class="n">PVehicle</span><span class="o">-&gt;</span><span class="n">Wheels</span><span class="p">[</span><span class="n">WheelIdx</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">PWheel</span><span class="p">.</span><span class="n">Setup</span><span class="p">().</span><span class="n">EngineEnabled</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">PWheel</span><span class="p">.</span><span class="n">SetDriveTorque</span><span class="p">(</span><span class="n">TorqueMToCm</span><span class="p">(</span><span class="n">TransmissionTorque</span><span class="p">)</span> <span class="o">*</span> <span class="n">PWheel</span><span class="p">.</span><span class="n">Setup</span><span class="p">().</span><span class="n">TorqueRatio</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">PWheel</span><span class="p">.</span><span class="n">SetDriveTorque</span><span class="p">(</span><span class="mf">0.</span><span class="n">f</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="p">}</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>You can see where it passes sets the engine rpm at line 19, where it reads out torque at line 28, and where it passes that torque to the wheels on line 40. Super easy. So to replace the engine, you just have to subclass <code class="language-plaintext highlighter-rouge">UChaosWheeledVehicleSimulation</code>, pass in the RPM, simulate, and read out the torque and apply it to the wheels. The plugin does something a bit different.</p> <figure class="highlight"><pre><code class="language-c--" data-lang="c++"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
</pre></td> <td class="code"><pre><span class="kt">void</span> <span class="n">UEngineSimulatorWheeledVehicleSimulation</span><span class="o">::</span><span class="n">ProcessMechanicalSimulation</span><span class="p">(</span><span class="kt">float</span> <span class="n">DeltaTime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EngineSimulatorThread</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">// Retrieve output from the last frame</span>
		<span class="n">FEngineSimulatorOutput</span> <span class="n">SimulationOutput</span><span class="p">;</span>
		<span class="p">{</span>
			<span class="n">FScopeLock</span> <span class="n">Lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EngineSimulatorThread</span><span class="o">-&gt;</span><span class="n">OutputMutex</span><span class="p">);</span>
			<span class="n">SimulationOutput</span> <span class="o">=</span> <span class="n">EngineSimulatorThread</span><span class="o">-&gt;</span><span class="n">Output</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="c1">// Copy the output so we can sample it on this thread and on the game thread</span>
		<span class="p">{</span>
			<span class="n">FScopeLock</span> <span class="n">Lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LastOutputMutex</span><span class="p">);</span>
			<span class="n">LastOutput</span> <span class="o">=</span> <span class="n">SimulationOutput</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">auto</span><span class="o">&amp;</span> <span class="n">PTransmission</span> <span class="o">=</span> <span class="n">PVehicle</span><span class="o">-&gt;</span><span class="n">GetTransmission</span><span class="p">();</span>

		<span class="c1">// Sample wheel RPM and average it. It only samples the wheels that are in contact with the ground and not slipping</span>
		<span class="kt">bool</span> <span class="n">bWheelsInContact</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="kt">float</span> <span class="n">WheelRPM</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">int32</span> <span class="n">SampledWheels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">I</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">I</span> <span class="o">&lt;</span> <span class="n">PVehicle</span><span class="o">-&gt;</span><span class="n">Wheels</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span> <span class="n">I</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">PVehicle</span><span class="o">-&gt;</span><span class="n">Wheels</span><span class="p">[</span><span class="n">I</span><span class="p">].</span><span class="n">EngineEnabled</span> 
				<span class="o">&amp;&amp;</span> <span class="n">PVehicle</span><span class="o">-&gt;</span><span class="n">Wheels</span><span class="p">[</span><span class="n">I</span><span class="p">].</span><span class="n">bInContact</span> 
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">PVehicle</span><span class="o">-&gt;</span><span class="n">Wheels</span><span class="p">[</span><span class="n">I</span><span class="p">].</span><span class="n">IsSlipping</span><span class="p">())</span>
			<span class="p">{</span>
				<span class="n">WheelRPM</span> <span class="o">+=</span> <span class="n">PVehicle</span><span class="o">-&gt;</span><span class="n">Wheels</span><span class="p">[</span><span class="n">I</span><span class="p">].</span><span class="n">GetWheelRPM</span><span class="p">();</span>
				<span class="n">bWheelsInContact</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">SampledWheels</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SampledWheels</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">WheelRPM</span> <span class="o">/=</span> <span class="n">SampledWheels</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="c1">// Final drive ratio is controlled by Unreal, but the rest of the transmission gearing</span>
		<span class="c1">// is controlled by engine simulator.</span>
		<span class="c1">// </span>
		<span class="c1">// So we apply final gearing ratio here before we pass it into engine sim. Engine sim will then apply transmission gearing</span>
		<span class="kt">float</span> <span class="n">DynoSpeed</span> <span class="o">=</span> <span class="n">WheelRPM</span> <span class="o">*</span> <span class="n">PTransmission</span><span class="p">.</span><span class="n">Setup</span><span class="p">().</span><span class="n">FinalDriveRatio</span><span class="p">;</span>

		<span class="c1">// Give engine simulator the input parameters for the simulation</span>
		<span class="p">{</span>
			<span class="n">EngineSimulatorThread</span><span class="o">-&gt;</span><span class="n">InputMutex</span><span class="p">.</span><span class="n">Lock</span><span class="p">();</span>
			<span class="n">EngineSimulatorThread</span><span class="o">-&gt;</span><span class="n">Input</span><span class="p">.</span><span class="n">DeltaTime</span> <span class="o">=</span> <span class="n">DeltaTime</span><span class="p">;</span>
			<span class="n">EngineSimulatorThread</span><span class="o">-&gt;</span><span class="n">Input</span><span class="p">.</span><span class="n">InContactWithGround</span> <span class="o">=</span> <span class="n">bWheelsInContact</span><span class="p">;</span>
			<span class="n">EngineSimulatorThread</span><span class="o">-&gt;</span><span class="n">Input</span><span class="p">.</span><span class="n">EngineRPM</span> <span class="o">=</span> <span class="n">DynoSpeed</span><span class="p">;</span>
			<span class="n">EngineSimulatorThread</span><span class="o">-&gt;</span><span class="n">Input</span><span class="p">.</span><span class="n">FrameCounter</span> <span class="o">=</span> <span class="n">GFrameCounter</span><span class="p">;</span>
			<span class="n">EngineSimulatorThread</span><span class="o">-&gt;</span><span class="n">InputMutex</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="c1">// Tell the engine thread to simulate</span>
		<span class="n">EngineSimulatorThread</span><span class="o">-&gt;</span><span class="n">Trigger</span><span class="p">();</span>

		<span class="c1">// Apply drive torque to wheels</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">WheelIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">WheelIdx</span> <span class="o">&lt;</span> <span class="n">Wheels</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span> <span class="n">WheelIdx</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">auto</span><span class="o">&amp;</span> <span class="n">PWheel</span> <span class="o">=</span> <span class="n">PVehicle</span><span class="o">-&gt;</span><span class="n">Wheels</span><span class="p">[</span><span class="n">WheelIdx</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">PWheel</span><span class="p">.</span><span class="n">Setup</span><span class="p">().</span><span class="n">EngineEnabled</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="kt">float</span> <span class="n">OutWheelTorque</span> <span class="o">=</span> <span class="n">Chaos</span><span class="o">::</span><span class="n">TorqueMToCm</span><span class="p">(</span><span class="n">SimulationOutput</span><span class="p">.</span><span class="n">Torque</span> <span class="o">*</span> <span class="n">PTransmission</span><span class="p">.</span><span class="n">Setup</span><span class="p">().</span><span class="n">FinalDriveRatio</span><span class="p">)</span> <span class="o">*</span> <span class="n">PWheel</span><span class="p">.</span><span class="n">Setup</span><span class="p">().</span><span class="n">TorqueRatio</span><span class="p">;</span>
				<span class="n">PWheel</span><span class="p">.</span><span class="n">SetDriveTorque</span><span class="p">(</span><span class="n">OutWheelTorque</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">PWheel</span><span class="p">.</span><span class="n">SetDriveTorque</span><span class="p">(</span><span class="mf">0.</span><span class="n">f</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="p">}</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Since engine simulator is way too heavy to run synchronously, the plugin runs it asynchronously in its own thread and does the reading and writing in reverse. First it reads the output from the last frame of the simulator, then it passes in the mechanical simulation input to Engine Simulator, and finally it triggers engine simulator to start simulating <em>at the end</em> of this frame. Thus, it’ll get the output of the triggered simulation in the next frame. This means engine simulator always runs a frame behind the rest of the game, but I think it’s a totally acceptable amount of latency, and is imperceptible in game.</p> <h2 id="sound-output">Sound Output</h2> <p>The sound output from the engine is done separately from the mechanical simulation. Each engine simulator movement component contains a procedural sound output: <code class="language-plaintext highlighter-rouge">USoundWaveProcedural* OutputEngineSound</code>. This procedural sound output is set to sample from Engine Simulator using <code class="language-plaintext highlighter-rouge">void FEngineSimulator::FillAudio(USoundWaveProcedural* Wave, const int32 SamplesNeeded)</code>:</p> <figure class="highlight"><pre><code class="language-c--" data-lang="c++"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td> <td class="code"><pre><span class="kt">void</span> <span class="n">FEngineSimulator</span><span class="o">::</span><span class="n">FillAudio</span><span class="p">(</span><span class="n">USoundWaveProcedural</span><span class="o">*</span> <span class="n">Wave</span><span class="p">,</span> <span class="k">const</span> <span class="n">int32</span> <span class="n">SamplesNeeded</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Unreal engine uses a fixed sample size.</span>
    <span class="k">static</span> <span class="k">const</span> <span class="n">uint32</span> <span class="n">SAMPLE_SIZE</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uint16</span><span class="p">);</span>

    <span class="k">const</span> <span class="n">uint32</span> <span class="n">SampleCount</span> <span class="o">=</span> <span class="n">SamplesNeeded</span><span class="p">;</span>
    <span class="kt">int16_t</span><span class="o">*</span> <span class="n">samples</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int16_t</span><span class="p">[</span><span class="n">SamplesNeeded</span><span class="p">];</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">readSamples</span> <span class="o">=</span> <span class="n">m_simulator</span><span class="p">.</span><span class="n">readAudioOutput</span><span class="p">(</span><span class="n">SamplesNeeded</span><span class="p">,</span> <span class="n">samples</span><span class="p">);</span>

    <span class="n">Wave</span><span class="o">-&gt;</span><span class="n">QueueAudio</span><span class="p">((</span><span class="k">const</span> <span class="n">uint8</span><span class="o">*</span><span class="p">)</span><span class="n">samples</span><span class="p">,</span> <span class="n">SampleCount</span> <span class="o">*</span> <span class="n">SAMPLE_SIZE</span><span class="p">);</span>
<span class="p">}</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Passing <code class="language-plaintext highlighter-rouge">OutputEngineSound</code> to a sound component in the game world and calling <code class="language-plaintext highlighter-rouge">play</code> on the component plays the engine simulator sound in game. From there you can apply sound modifiers to the engine noise to EQ it, reverb it, whatever. Unfortunately as of Unreal Engine 5.0.3 you can’t use <code class="language-plaintext highlighter-rouge">USoundWaveProcedural</code> as an input to a Metasound, but I think they’re fixing this in 5.1, so you’ll be able to manipulate Engine Simulator using Metasound 😎</p> <h2 id="engine-simulator-side">Engine Simulator side</h2> <p>Connecting Engine Simulator to Unreal on the Engine Simulator side was dead simple. Engine Simulator comes with a class <code class="language-plaintext highlighter-rouge">Dynamometer</code> that connects to the engine crankshaft, spins at a set rotational speed, and measures the torque output. Getting it to work was as easy as passing in the RPM, simulating, and reading out the torque.</p> <hr> <h1 id="download-links">Download Links</h1> <ul> <li><a href="https://github.com/nicholas477/EngineSimulatorPlugin" rel="external nofollow noopener" target="_blank">Plugin Link</a></li> <li><a href="git@github.com:nicholas477/EngineSimulatorGame.git">Example Project Link</a></li> </ul> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Nicholas Chalkley. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. Last updated: June 30, 2024. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script type="text/javascript">$(function(){$('[data-toggle="tooltip"]').tooltip()});</script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-8SQ3HQJMBJ"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8SQ3HQJMBJ");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>